<!-- messaging.component.html -->
<div class="gradient-bg text-gray-100 min-h-screen flex overflow-hidden">
  <!-- Sidebar -->
  <div class="sidebar-bg w-80 min-h-screen flex flex-col border-r border-gray-700 z-50">
    <div class="p-6 flex items-center space-x-3 border-b border-gray-700">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
      </svg>
      <span class="text-2xl font-bold text-gradient">Messagerie</span>
    </div>

    <!-- Search -->
    <div class="p-4 border-b border-gray-700">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="text"
          class="bg-gray-700 w-full pl-10 pr-4 py-2 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Rechercher des messages..."
          [(ngModel)]="searchQuery"
          (input)="filterConversations()"
        >
      </div>
    </div>

    <!-- Conversation List -->
    <div class="flex-1 overflow-y-auto scrollbar-thin">
      <div *ngFor="let group of conversationGroups" class="px-2 py-3">
        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mb-2">{{ group.title }}</h4>
        <div class="space-y-1">
          <div
            *ngFor="let conv of group.conversations"
            class="conversation-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer"
            [ngClass]="{'active': selectedConversation?.id === conv.id}"
            (click)="selectConversation(conv)"
          >
            <div class="relative">
              <ng-container *ngIf="conv.image; else initialAvatar">
                <img [src]="conv.image" alt="Profile" class="w-10 h-10 rounded-full object-cover">
              </ng-container>
              <ng-template #initialAvatar>
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium">{{ conv.initials }}</div>
              </ng-template>
              <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-gray-800" [ngClass]="conv.online ? 'bg-green-500' : 'bg-gray-500'"></span>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-medium truncate">{{ conv.name }}</h4>
              <p class="text-sm text-gray-400 truncate">{{ conv.lastMessage }}</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-gray-400">{{ conv.time }}</span>
              <span *ngIf="conv.unreadCount" class="block w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center ml-auto mt-1">{{ conv.unreadCount }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Chat Header -->
    <div class="bg-gray-800 bg-opacity-90 backdrop-filter backdrop-blur-lg border-b border-gray-700 flex items-center justify-between px-6 py-4">
      <div class="flex items-center space-x-4">
        <div class="relative">
          <img [src]="selectedConversation?.image || 'https://randomuser.me/api/portraits/women/32.jpg'" alt="Profile" class="w-10 h-10 rounded-full object-cover">
          <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800"></span>
        </div>
        <div>
          <h3 class="font-bold">{{ selectedConversation?.name || 'Sophie Martin' }}</h3>
          <p class="text-xs text-gray-400">{{ selectedConversation?.online ? 'En ligne' : 'Hors ligne' }}</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <button class="text-gray-400 hover:text-white" (click)="startCall()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
        </button>
        <button class="text-gray-400 hover:text-white" (click)="startVideoCall()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </button>
        <button class="text-gray-400 hover:text-white" (click)="openOptions()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div #messagesContainer class="flex-1 overflow-y-auto p-6 scrollbar-thin bg-gray-900 bg-opacity-50" [class]="isLoading ? 'flex justify-center items-center' : ''">
      <div *ngIf="isLoading" class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
        <p class="text-gray-400">Chargement de la conversation...</p>
      </div>
      <ng-container *ngIf="!isLoading">
        <div *ngFor="let message of messages" [ngClass]="message.isSent ? 'flex justify-end mb-4 message-out' : 'flex mb-4 message-in'">
          <div *ngIf="!message.isSent" class="flex-shrink-0 mr-3">
            <img [src]="selectedConversation?.image || 'https://randomuser.me/api/portraits/women/32.jpg'" alt="Profile" class="w-8 h-8 rounded-full object-cover">
          </div>
          <div class="max-w-xs md:max-w-md lg:max-w-lg">
            <div [ngClass]="message.isSent ? 'bg-blue-600 rounded-lg p-3' : 'bg-gray-700 rounded-lg p-3'" *ngIf="!message.isTyping && !message.attachment; else typingOrAttachment">
              <p>{{ message.text }}</p>
            </div>
            <ng-template #typingOrAttachment>
              <div *ngIf="message.isTyping" class="bg-gray-700 rounded-lg p-3">
                <div class="typing-indicator">
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                </div>
              </div>
              <div *ngIf="message.attachment" class="bg-gray-700 rounded-lg overflow-hidden">
                <div class="p-3 border-b border-gray-600">
                  <p>{{ message.text }}</p>
                </div>
                <div class="p-3 bg-gray-800">
                  <div class="flex items-center">
                    <div class="bg-blue-500 bg-opacity-20 p-2 rounded-lg mr-3">
                      <i class="fas fa-file-code text-blue-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-medium truncate">{{ message.attachment.name }}</p>
                      <p class="text-xs text-gray-400">{{ message.attachment.type }} · {{ message.attachment.size }}</p>
                    </div>
                    <button class="text-blue-400 hover:text-blue-300 ml-3" (click)="downloadAttachment(message.attachment)">
                      <i class="fas fa-download"></i>
                    </button>
                  </div>
                </div>
              </div>
            </ng-template>
            <p [ngClass]="message.isSent ? 'text-xs text-gray-400 mt-1 text-right' : 'text-xs text-gray-400 mt-1'">
              {{ message.time }}
              <i *ngIf="message.isSent" [ngClass]="message.read ? 'fas fa-check-double' : 'fas fa-check'" class="ml-1 text-blue-400"></i>
            </p>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Message Input -->
    <div class="bg-gray-800 bg-opacity-90 backdrop-filter backdrop-blur-lg border-t border-gray-700 p-4">
      <div class="flex items-center">
        <button class="text-gray-400 hover:text-white mr-3" (click)="attachFile()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <div class="flex-1 relative" #inputContainer>
          <input
            type="text"
            class="bg-gray-700 w-full pl-4 pr-12 py-3 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Écrire un message..."
            [(ngModel)]="newMessage"
            (focus)="onInputFocus()"
            (blur)="onInputBlur()"
            (keypress)="onKeyPress($event)"
          >
          <div class="absolute right-3 top-3 flex space-x-2">
            <button class="text-gray-400 hover:text-white" (click)="addEmoji()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            <button class="text-gray-400 hover:text-white" (click)="sendVoiceMessage()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </button>
          </div>
        </div>
        <button class="ml-3 bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full glow-on-hover btn-press" (click)="sendMessage()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>